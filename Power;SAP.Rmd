---
title: "POWER & SAP"
author: "SP"
date: "2023-03-24"
output:
  html_document:
    df_print: paged
  word_document:
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## POWER & SAMPLE SIZE

```{r include=FALSE}
library(ThreeArmedTrials)
```

### OPTIMAL SAMPLE SIZE ALLOCATION CALCULATION

```{r}
w <- ThreeArmedTrials::opt_alloc_RET(experiment = 0.4, 
                                     reference = 0.2, 
                                     placebo = 0.05,
                                     Delta = 0.7,
                                     distribution = "binary", 
                                     h = function(x){-log(x/(1-x))})
print(w)
```

The optimal sample size allocation for a Wald-type test for a three-armed superiority trial, where the probability rate of patients on TLE600 who will lose ≥5% weight is estimated to be 40%, for TLE400 is estimated to be 20%, and for the reference group continuing on TLD is estimated to be 5%, with a superiority margin of a log odds 0.7 (odds ratio of 2) and a binary distribution following a logit link function, is estimated to be 39.5%, 33.9%, and 26.6% approximately for the TLE600, TLE400, and TLD group respectively.

### SAMPLE SIZE AND POWER RELATED CALCULATIONS

```{r}
#With optimal allocation
ThreeArmedTrials::power_RET(experiment = 0.4, 
                            reference = 0.2, 
                            placebo = 0.05,
                            sig_level = 0.05, 
                            power = 0.8,
                            Delta = 0.7, 
                            allocation = w, 
                            distribution = "binary", 
                            h = function(x){-log(x/(1-x))}, 
                            h_inv = function(x){exp(-x)/(1+exp(-x))},
                            var_estimation = "RML")
```

The sample size for a Wald-type test for superiority of transitioning to TLE600 versus TLE400 with respect to maintenance on TLD assuming a probability rate for outcomes of 40% in the TLE600 group, 20% in the TLE400 group, and 5% in the TLD group, an alpha error of 5%, power at 80%, a superiority margin log odds of 0.7 (odds ratio of 2) is calculated to be 29, 25, and 19 in the TLE600, TLE400, and TLD arms respectively.

```{r}
#With 1:1:1 allocation
ThreeArmedTrials::power_RET(experiment = 0.4, 
                            reference = 0.2, 
                            placebo = 0.05,
                            sig_level = 0.05, 
                            power = 0.8,
                            Delta = 0.7, 
                            allocation = c(1, 1, 1)/3, 
                            distribution = "binary", 
                            h = function(x){-log(x/(1-x))}, 
                            h_inv = function(x){exp(-x)/(1+exp(-x))},
                            var_estimation = "RML")
```

The goal is to see whether transitioning to TLE600 is clearly superior to transitioning to TLE400 from TLD with respect to maintaining on TLD in losing clinically significant bodyweight (≥5%) at 48 weeks in patients transitioning from TLD. Following this, the primary hypothesis that arises is:

1.  Whether transitioning to TLE600 from TLD is superior to transitioning to TLE400 with respect to maintenance on TLD in losing clinically significant bodyweight (≥5%) at 48 weeks.

Secondary hypotheses include:

1.  Whether transitioning to TLE600 from TLD is superior to maintenance on TLD in losing clinically significant bodyweight (≥5%) at 48 weeks.
2.  Whether transitioning to TLE400 from TLD is superior to maintenance on TLD in losing clinically significant bodyweight (≥5%) at 48 weeks.
3.  Whether transitioning to TLE600 from TLD is superior to transitioning to TLE400 from TLD with respect to maintenance on TLD in losing clinically significant bodyweight (≥5%) at 48 weeks after stratifying for type 2 diabetes mellitus.

Based on clinical judgement, we anticipate that there is 40% probability that patients on TLE600 will lose clinically significant bodyweight (≥5%) after transitioning from TLD, 20% probability that patients on TLE400 will lose clinically significant bodyweight (≥5%) after transitioning from TLD , and 5% probability that patients maintained on TLD will lose clinically significant bodyweight (≥5%).

Sample size is calculated for a superiority three-arm trial with binary endpoints using the logit link function for a Wald-type test using the restricted variance estimation (RML). The allocation ratio is 1:1:1. We decided a log odds superiority margin (delta) of 0.7 (corresponding to an odds ratio of 2) to be clinically significant to investigate the superiority of TLE600 over TLE400. The required sample size for achieving 80% power at a significance level of 5% is 27 patients in each group (N = 81). Assuming a dropout rate of approximately 20% over a 48-week period in an urban population, we plan to recruit 35 patients in each group (N = 105).

### TESTING THE RETENTION OF EFFECT HYPOTHESIS

```{r include=FALSE}
df1 <- read.csv("C:/Users/SURHUD/Desktop/Desktop/Stats/DTG to EFV - Weight Suppression (DEWS)/RoE data.csv")
df1$Experimental <- as.numeric(df1$Outcome)
df1$Group <- as.factor(df1$Group)
```

```{r include=FALSE}
df1$Group <- relevel(df1$Group, ref = "TLE400")
```

```{r include=FALSE}
df1$Group <- relevel(df1$Group, ref = "TLD")
```

```{r}
ThreeArmedTrials::test_RET(xExp = df1$Outcome[df1$Group == "TLE600"],
                           xRef = df1$Outcome[df1$Group == "TLE400"],
                           xPla = df1$Outcome[df1$Group == "TLD"], 
                           Delta = 0.7, 
                           var_estimation = "RML",
                           distribution = "binary",
                           h = function(x){-log(x/(1-x))},
                           h_inv = function(x){exp(-x)/(1+exp(-x))})
```

```{r}
fit <- glm(formula = Outcome ~ Group, family = binomial, data = df1)
summary(fit)
coef(fit)
confint(fit)
```

We tested the retention of effect hypothesis on a simulated dataset with 1:1:1 allocation and 35 participants in each group. Fourteen patients on TLE600, seven patients on TLE400, and two patients on TLD lost clinically significant bodyweight (≥5%). A Wald-type test yielded a statistically significant p-value (p = 2.494e-03) between the TLE600 and TLE400 groups with respect to TLD indicating that there is a significant difference between the groups.

```{r include=FALSE}
df2 <- read.csv("C:/Users/SURHUD/Desktop/Desktop/Stats/DTG to EFV - Weight Suppression (DEWS)/CI figure.csv")
```

```{r include=FALSE}
library(ggplot2)
```

```{r}
ggplot2::ggplot(data = df2) + 
         geom_errorbar(aes(xmin = LCL, xmax = UCL, y = ID)) + 
         geom_vline(xintercept = c(0, 0.7), lty = c(1, 4)) + 
         scale_x_continuous(breaks = seq(-0.2, 3.2, 0.2)) +
         theme_minimal() +
         xlab("Log Odds")
```

1.  Shows the lower confidence limit for the log odds which is far away from the superiority margin (delta) at 0.7 - superiority shown.
2.  Shows the lower confidence limit for the log odds which is close, but not crossing the superiority margin (delta) at 0.7 - superiority shown.
3.  Shows the confidence interval crossing the superiority margin (delta) at 0.7 - superiority not shown.
4.  Shows the confidence interval with the upper confidence limit lower than the superiority margin (delta) at 0.7 - superiority not shown.
5.  Shows the confidence interval with the upper confidence limit lower than the superiority margin (delta) at 0.7 - superiority not shown.
6.  Shows the confidence interval with the upper confidence limit lower than the superiority margin (delta) at 0.7 - superiority not shown.

## STATISTICAL ANALYSIS PLAN

The intention-to-treat protocol will be followed to maintain randomization and sample size. The primary endpoint will a comparison of the TLE600 arm to the TLE400 arm with respect to the TLD arm in losing clinically significant bodyweight (≥5%). Since the goal is to see whether TLE600 is superior to TLE400 in losing clinically significant bodyweight (≥5%) at 48 weeks, the primary hypothesis will be whether transitioning to TLE600 from TLD is superior to transitioning to TLD400 from TLD with respect to maintenance on TLD. We anticipate the TLE600 arm to show the highest reduction in bodyweight , the TLD arm to show the least reduction in bodyweight, and the TLE400 ar to show an intermediate reduction in bodyweight at 48 weeks.

For the primary outcome, a logistic regression model will be used to compare the odds of achieving clinically significant bodyweight loss (≥5%) with the TLD arm serving as the reference class. The model will be adjusted to the following confounding variables: presence of diabetes mellitus, age, sex, duration on TLD, baseline BMI, and baseline CD4 levels. Linear mixed effects regression models with each participant as a random intercept will be used to fit and predict CD4 counts, weight, BMI, wait-hip ratio, blood sugar levels, HbA1c levels, lipid parameters, and estimated GFR over time. Logistic regression models adjusted for confounders will be used to estimate the odds of events with their risk factors. Kaplan-Meier analyses will be performed to estimate median times to events. The log-rank test will be used to compare Kaplan-Meier estimates. Cox regression models adjusted for confounders will be used to get hazard estimates for the occurrence of events over time. The proportional hazards assumption will be tested using Schoenfeld residuals. Chi-square or Fisher's exact tests will be used to compare categorical variables as appropriate. The Cochran-Mantel-Haenszel test will be used for simple stratified analysis. Student's t-tests or analysis of variance techniques (ANOVA) will be used to compare continuous variables for two or more groups respectively. Patients who had achieved events of interest at baseline will be censored from the concerned analyses.

Subgroup analyses will be performed to assess the robustness and validity of the results, and whether associations are stronger or weaker in different subgroups. Similar statistical methods will be used in subgroup analyses to those used to assess primary and secondary outcomes. Subgroups will include patients with baseline BMI ≥25 kg/sqm and those with \<25 kg/sqm, males and females, family history of obesity and those without, CyP2B polymorphisms and those without, and those with baseline CD4 ≤350 cells/cumm and those \>350 cells/cumm.

For the two co-primary outcomes, p-values less than the alpha significance level of 0.025 will be considered to be statistically significant. For the rest of the secondary outcomes, p-values less than 0.001 will be considered to be statistically significant; exact p-values, effect sizes and point estimates with their 95% confidence intervals will be reported.
